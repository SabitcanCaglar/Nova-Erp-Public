@{ int? kullanıcıId = Context.Session.GetInt32("Id");}
@{ string kullanıcıadsoyad = Context.Session.GetString("AdSoyad");}


@{
    Layout = null;
}
@model TaslakSiparisOlusturModel;

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
</head>
<body>

    <button class="btn btn-danger" id="SiparisTaslakHubBtn" style="visibility: hidden"></button>

   
    <div class="row">
        <div class="col-sm-12">
            <div class="panel panel-default card-view" style="background-color: #c9222a;height:180px;opacity:1">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-sm-4">
                            <img style="width:200px;height:150px;float:left" src="~/img/YENİSİPARİŞ/müsteribilgi2.png" />
                            
                        </div>
                        <div class="col-sm-4">
                            <h2 style="color:white;text-align:center">MÜŞTERİ BİLGİLERİ</h2><br />
                            <h5 style="color:white;text-align:center;font-size:20px"><u>Taslak Sipariş Kodu</u></h5>

                            <h3 style="color:white;text-align:center">@Model.siparisTaslakDetay.SiparisKodu</h3>
                        </div>
                        <div class="col-sm-4">
                            <img style="width:200px;height:150px;float:right" src="~/img/YENİSİPARİŞ/müsteribilgi2ters.png" />
                        </div>



                    </div>
                    <div class="clearfix"></div>
                </div>
                <div class="panel-wrapper collapse in">
                    <div class="panel-body">




                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-sm-12">
            <div class="panel panel-default card-view">
                <div class="panel-heading">
                    <div class="pull-center">
                        <h2 style="text-align: center; font-size: 25px" class="panel-title txt-dark">@Model.musteri.Adi  @Model.musteri.Soyadi için..</h2>
                        <h4 style="text-align:center">Sipariş Taslak Oluşturdunuz..</h4><br />
                    </div>
                    <div class="clearfix"></div>
                </div>
                <div class="panel-wrapper collapse in">
                    <div class="panel-body">

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-wrap">
                                    <form class="form-horizontal" role="form">
                                        <div class="form-body">
                                            <p class="text-dark" style="float:right;font-size:13px">Kullanıcı: @kullanıcıadsoyad </p>
                                            <h6 class="txt-dark capitalize-font"><i class="icon-user mr-10"></i>Müşteri Bilgileri</h6>

                                            <hr>
                                            <div class="row">

                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-3">Müşteri Adı :</label>
                                                        <div class="col-md-9">
                                                            <p class="form-control-static"> @Model.musteri.Adi  </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--/span-->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-3">Müşteri Soyadı :</label>
                                                        <div class="col-md-9">
                                                            <p class="form-control-static"> @Model.musteri.Soyadi  </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--/span-->
                                            </div>
                                            <!-- /Row -->
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-3">Firma Bilgisi :</label>
                                                        <div class="col-md-9">
                                                            <p class="form-control-static"> @Model.musteri.Firma  </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--/span-->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-3">Telefon Numarası:</label>
                                                        <div class="col-md-9">
                                                            <p class="form-control-static"> @Model.musteri.TelefonNo </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--/span-->
                                            </div>
                                            <!-- /Row -->
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-3">Ülke :</label>
                                                        <div class="col-md-9">
                                                            <p class="form-control-static">  @Model.musteri.Ulke </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--/span-->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-3">Adres :</label>
                                                        <div class="col-md-9">
                                                            <p class="form-control-static">  @Model.musteri.Adres </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--/span-->
                                            </div>
                                            <!-- /Row -->
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>







                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-sm-12">
            <div class="panel panel-default card-view" style="background-color:#05cfb3;height:180px;opacity:1">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-sm-4">
                            <img style="width:200px;height:150px;float:left" src="~/img/YENİSİPARİŞ/ÖncekiSiparis.png" />
                        </div>
                        <div class="col-sm-4">
                            <h2 style="color:white;text-align:center">ÖNCEKİ SİPARİŞLER</h2><br />
                            <h5 style="color:white;text-align:center;font-size:20px"><u>Taslak Sipariş Kodu</u></h5>

                            <h3 style="color:white;text-align:center">@Model.siparisTaslakDetay.SiparisKodu</h3>
                        </div>
                        <div class="col-sm-4">
                            <img style="width:200px;height:150px;float:right" src="~/img/YENİSİPARİŞ/ÖncekiSiparis2.png" />
                        </div>



                    </div>
                    <div class="clearfix"></div>
                </div>
                <div class="panel-wrapper collapse in">
                    <div class="panel-body">




                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="panel panel-default card-view">
                <div class="panel-heading">
                    <div class="pull-center">
                        <h2 style="text-align: center; font-size: 25px" class="panel-title txt-dark">TOP 5</h2>
                    </div>
                    <div class="clearfix"></div>
                </div>
                <div class="panel-wrapper collapse in">
                    <div class="panel-body">

                        <div id="chartdiv" style="width:100%; height: 600px"></div>


                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- #endregion -->



    <div class="row">
        <div class="col-sm-12">
            <div class="panel panel-default card-view" style="background-color: #ffb012; height: 180px; opacity: 1">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-sm-4">
                            <img style="width:200px;height:150px;float:left" src="~/img/YENİSİPARİŞ/ÜrünEkle.png" />
                        </div>
                        <div class="col-sm-4">
                            <h2 style="color:white;text-align:center">ÜRÜN EKLE</h2><br />
                            <h5 style="color:white;text-align:center;font-size:20px"><u>Taslak Sipariş Kodu</u></h5>

                            <h3 style="color:white;text-align:center">@Model.siparisTaslakDetay.SiparisKodu</h3>
                        </div>
                        <div class="col-sm-4">
                            <img style="width:200px;height:150px;float:right" src="~/img/YENİSİPARİŞ/ÜrünEkle.png" />
                        </div>



                    </div>
                    <div class="clearfix"></div>
                </div>
                <div class="panel-wrapper collapse in">
                    <div class="panel-body">




                    </div>
                </div>
            </div>
        </div>
    </div>



    <div class="row">
        <div class="col-sm-12">
            <div class="panel panel-default card-view">
                <div class="panel-heading">
                    <div class="pull-center">
                        <h2 style="text-align: center; font-size: 25px" class="panel-title txt-dark">ÜRÜN LİSTESİ</h2>
                    </div>
                    <div class="clearfix"></div>
                </div>
                <div class="panel-wrapper collapse in">
                    <div class="panel-body">

                        <table id="uruntablo" class="table table-border-style wrap">


                            <thead class="wrap">
                                <tr>
                                    <th>Id</th>
                                    <th>GüncelleyenpersonelId</th>
                                    <th style="text-align:center">Ürün Kodu</th>
                                    <th style="text-align:center">Ürün Adı</th>
                                    <th style="text-align:center">Satış Fiyat</th>
                                    <th style="text-align:center">Stok Adet</th>
                                    <th style="text-align:center">Renk Kodu</th>
                                    <th style="text-align:center">Kategori</th>
                                    <th style="text-align:center">Alt <br /> Kategori</th>
                                    <th style="align-items:center">Miktar</th>
                                    <th style="align-items:center">Birim</th>
                                    <th style="align-items:center">Sipariş</th>


                                </tr>
                            </thead>
                        </table>
                        <br />
                        <br />
                        <br />

                        <h3 style="color: #2c466b; text-align: center"> ÖNCEKİ SİPARİŞLERDEN KOPYALA </h3><br /><br />

                        <table id="oncekiSiparisTablo" class="table table-border-style wrap">


                            <thead class="wrap">
                                <tr>
                                    <th>Id</th>
                                    <th>GüncelleyenpersonelId</th>
                                    <th>ÜrünId</th>
                                    <th style="text-align:center">Ürün Kodu</th>
                                    <th style="text-align:center">Ürün Adı</th>
                                    <th style="text-align:center">Satış Fiyat</th>
                                    <th style="text-align:center">Stok Adet</th>
                                    <th style="text-align:center">Renk Kodu</th>
                                    <th style="text-align:center">Kategori</th>
                                    <th style="text-align:center">Alt <br /> Kategori</th>

                                    <th style="align-items:center">Miktar</th>
                                    <th style="align-items:center">Birim</th>
                                    <th style="align-items:center">Kopyala</th>


                                </tr>
                            </thead>
                        </table><br /><br /><br /><br />
                        <div class="col-md-9">

                        </div>

                        <button id="siparisonayla" type="submit" style=" font-size: 25px " onclick="SiparisOnayUrunListesi()" class="btn btn-primary btn-anim"><i class="fa fa-shopping-basket fa-9x"></i><span class=" btn-text">Sipariş Onayla</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-header-right">
        <input type="hidden" id="siparistaslakdetayid" value="@Model.siparisTaslakDetay.Id" />
        <input type="hidden" id="sipariskodu" value="@Model.siparisTaslakDetay.SiparisKodu" />
        <input type="hidden" id="sipariskodsıra" value="@Model.siparisTaslakDetay.SiparisKodSıra" />
        <input type="hidden" id="musteriId" value="@Model.musteri.Id" />
        <input type="hidden" id="ekleyenpersonelId" value="@kullanıcıId" />
        <input type="hidden" id="siparistaslakId" value="@Model.siparisTaslakDetay.SiparisTaslakId" />



    </div>

   




    <script>

        var musteri = {
            Id: $("#musteriId").val(),
        }
        $(document).ready(function () {
            
           
            $.ajax({
                type: "GET",
                url: "/YeniSiparis/MusteriTop5Liste",
                dataType: 'json',
                data:musteri,
                success: function (data) {

                    
                    chart.load(data);

                }






            });





        });

        var chart = {

            load: function (data) {

                am4core.ready(function () {

                    // Themes begin
                    am4core.useTheme(am4themes_kelly);
                    am4core.useTheme(am4themes_animated);
                    // Themes end

                    // Create chart instance
                    var chart = am4core.create("chartdiv", am4charts.XYChart3D);

                    // Add data
                    chart.data = data;

                    // Create axes
                    let categoryAxis = chart.xAxes.push(new am4charts.CategoryAxis());
                    categoryAxis.dataFields.category = "urunKodu";
                    categoryAxis.renderer.labels.template.rotation = 270;
                    categoryAxis.renderer.labels.template.hideOversized = false;
                    categoryAxis.renderer.minGridDistance = 20;
                    categoryAxis.renderer.labels.template.horizontalCenter = "right";
                    categoryAxis.renderer.labels.template.verticalCenter = "middle";
                    categoryAxis.tooltip.label.rotation = 270;
                    categoryAxis.tooltip.label.horizontalCenter = "right";
                    categoryAxis.tooltip.label.verticalCenter = "middle";

                    let valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
                    valueAxis.title.text = "Toplam Satış Miktarı";
                    valueAxis.title.fontWeight = "bold";

                    // Create series
                    var series = chart.series.push(new am4charts.ColumnSeries3D());
                    series.dataFields.valueY = "toplam";
                    series.dataFields.categoryX = "urunKodu";
                    series.name = "Toplam Satış Miktarı";
                    series.tooltipText = "{categoryX}: [bold]{valueY}[/]";
                    series.columns.template.fillOpacity = .8;

                    var columnTemplate = series.columns.template;
                    columnTemplate.strokeWidth = 2;
                    columnTemplate.strokeOpacity = 1;
                    columnTemplate.stroke = am4core.color("#FFFFFF");

                    columnTemplate.adapter.add("fill", function (fill, target) {
                        return chart.colors.getIndex(target.dataItem.index);
                    })

                    columnTemplate.adapter.add("stroke", function (stroke, target) {
                        return chart.colors.getIndex(target.dataItem.index);
                    })

                    chart.cursor = new am4charts.XYCursor();
                    chart.cursor.lineX.strokeOpacity = 0;
                    chart.cursor.lineY.strokeOpacity = 0;
                    chart.dataSource.reloadFrequency = 3000;
                });


                $('g:has(> g[stroke="#3cabff"])').hide();


            }


        };





        var oncekiSiparisTablo;
        $(document).ready(function () {
            window.scrollTo(0, 0);

           



            oncekiSiparisTablo = $('#oncekiSiparisTablo').DataTable({

                /*"dom": 'Blfrtip',*/

                "responsive": true, "lengthChange": false,
                "autoWidth": false, "processing": true,
                "serverSide": false, "select": false,
                "destroy": true,
                "lengthMenu": [[5, 10, 30, -1], [5, 10, 30, "All"]],
                "fixedHeader": true,
                "scrollX": true,
                "scrollY": true,

                "ajax": {
                    "url": "/YeniSiparis/OncekiSiparisler",
                    "data": musteri,
                    "type": "GET"
                },
                "columnDefs":
                    [
                        {
                            "targets": [0, 1, 2],
                            "visible": false,
                            "searchable": false,
                        },
                        {
                            "targets": [2, 3, 4, 5, 6, 7, 8, 9, 10],
                            "className": 'dt-body-center'

                        },



                    ],







                "columns": [




                    { "data": "id" },
                    { "data": "guncelleyenPersonelId" },
                    { "data": "urunId" },
                    { "data": "kodu" },
                    { "data": "adi" },
                    {
                        "data": "satisFiyat",
                        "render": function (satisFiyat) {
                            return '$' + satisFiyat;

                        }

                    },
                    { "data": "stokAdet" },
                    { "data": "renkKod" },
                    { "data": "kategori" },
                    { "data": "altKategori" },
                    { "data": "miktar" },
                    { "data": "birim" },



                    {
                        "data": null,
                        "className": "kopyala",
                        "render": function (data, type, row) {

                            return '  <button class="btn btn-primary btn-icon-anim btn-circle"><i class="fa fa-copy "></i></button> ';
                        },
                        "targets": -1
                    }


                ]


            });




            $('#oncekiSiparisTablo tbody').on('click', '.kopyala', function () {
                var data = oncekiSiparisTablo.row(this).data();




                urunkopyala(data);




            });



        });

        function urunkopyala(data) {




            Swal.fire({
                title: "<h2 style='color:#c9222a'>Siparişi Kopyalamak İçin Onaylayınız..</h2>",
                html: true,

                cancelButtonColor: '#c9222a',
                cancelButtonText: 'Vazgeç',
                showCancelButton: true,
                confirmButtonText: 'Onayla',
                confirmButtonColor: '#2c466b',
                showLoaderOnConfirm: true,
                allowOutsideClick: false,
                width: '600px',
                html:


                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                    '<label  class="  col-form-label" style="font-size:20px;float:left">Ürün Kodu</label><br />' +
                    ' <input type="text" style="height:38px;font-size:30px" value="' + data.kodu + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi"  disabled ><br />' +
                    '</div>' +
                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                    '<label  class=" col-form-label" style="font-size:20px;float:left">Renk Kodu</label><br />' +
                    ' <input type="text" style="height:38px;font-size:30px" value="' + data.renkKod + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi" disabled ><br />' +
                    '</div>' +
                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                    '<label  class="  col-form-label" style="font-size:20px;float:left">Kategori</label><br />' +
                    ' <input type="text" style="height:38px;font-size:30px" value="' + data.kategori + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi"  disabled><br />' +
                    '</div>' +
                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                    '<label  class=" col-form-label" style="font-size:20px;float:left">Fiyat</label><br />' +
                    ' <input type="text" style="height:38px;font-size:30px" value="' + '$' + data.satisFiyat + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi"  disabled ><br /><br />' +
                    '</div><br />' +

                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                    '<div class="col-md-1">' +
                    '</div>' +
                    ' <input type="number" style="width:205px;height:45px;font-size:40px;color:#c9222a" value="' + data.miktar + '" id="copymiktar" class="col-sm-5 form-control form-control-center" min="0" >' +
                    '<div class="col-md-1">' +
                    '</div>' +
                    '<select id="copybirim" style="width:205px;height:45px"  class="form-control col-md-5">' +
                    '<option value ="Adet" >Adet</option >' +
                    '<option value="Kilogram">Kilogram</option>' +
                    '<option value="Metre">Metre</option>' +
                    '<option value="Ton">Ton</option>' +
                    '</select >' +

                    '</div>' +








                    '</div>',




                preConfirm: () => {

                    var std = {
                        SiparisTaslakId: $("#siparistaslakId").val(),
                        UrunId: data.urunId,
                        UrunKodu: data.kodu,
                        UrunAdi: data.adi,
                        Miktar: $("#copymiktar").val(),
                        Birim: $("#copybirim").val(),
                        SiparisKodu: $("#sipariskodu").val(),
                        SiparisKodSıra: $("#sipariskodsıra").val(),
                        MüsteriId: $("#musteriId").val(),
                        EkleyenPersonelId: $("#ekleyenpersonelId").val(),

                    }
                    $.ajax({
                        type: "POST",
                        url: "/YeniSiparis/UrunEkle",
                        data: std,
                        dataType: 'json',
                        success: function (durum) {

                            if (durum == "basarili") {

                                Swal.fire({
                                    timer: 1500,
                                    showConfirmButton: false,
                                    icon: 'success',
                                    html: true,

                                    html:


                                        '<label class=" col-sm-11 col-form-label" style="font-size:50px;color:#2c466b">' + data.kodu + '</label><br />' +
                                        '<label class=" col-sm-11 col-form-label" style="font-size:50px;color:#c9222a">' + std.Miktar + ' ' + std.Birim + '</label><br />' +
                                        '<label class=" col-sm-11 col-form-label" style="font-size:30px;color:#2c466b">Başarılı Bir Şekilde Taslak Siparişe Eklendi..</label><br /><br />'
                                    ,

                                    confirmButtonColor: '#2c466b'

                                    /*footer: '<a href="">Why do I have this issue?</a>'*/
                                })

                                //var test = "Müşteri güncellendi.";
                                //$("#müsterihubbtn").trigger('müsterieklesilgüncelle', [test]);


                            }

                            else if (durum == "urunguncelle") {
                                Swal.fire({
                                    title: "<h2 style='color:#c9222a'>ÜRÜN SİPARİŞTE MEVCUT!</h2>",
                                    html: true,

                                    cancelButtonColor: '#c9222a',
                                    cancelButtonText: 'Vazgeç',
                                    showCancelButton: true,
                                    confirmButtonText: 'Onayla',
                                    confirmButtonColor: '#2c466b',
                                    showLoaderOnConfirm: true,
                                    allowOutsideClick: false,
                                    width: '600px',
                                    html:


                                        '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                                        '<label  class="  col-form-label" style="font-size:20px;float:left">Ürün Kodu</label><br />' +
                                        ' <input type="text" style="height:38px;font-size:30px" value="' + data.kodu + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi"  disabled ><br />' +
                                        '</div>' +
                                        '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                                        '<label  class=" col-form-label" style="font-size:20px;float:left">Renk Kodu</label><br />' +
                                        ' <input type="text" style="height:38px;font-size:30px" value="' + data.renkKod + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi" disabled ><br />' +
                                        '</div>' +
                                        '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                                        '<label  class="  col-form-label" style="font-size:20px;float:left">Kategori</label><br />' +
                                        ' <input type="text" style="height:38px;font-size:30px" value="' + data.kategori + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi"  disabled><br />' +
                                        '</div>' +
                                        '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                                        '<label  class=" col-form-label" style="font-size:20px;float:left">Fiyat</label><br />' +
                                        ' <input type="text" style="height:38px;font-size:30px" value="' + '$' + data.satisFiyat + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi"  disabled ><br />' +
                                        '</div><br />' +
                                        '<label class="  col-form-label" style="font-size:50px;color:#2c466b">' + std.Miktar + ' ' + std.Birim + '</label><br /><br />' +
                                        '<label class="  col-form-label" style="font-size:30px;color:#2c466b">Olarak Güncellenecek Onalıyor Musunuz??</label><br /><br /><br />' +

                                        '</div>',





                                    preConfirm: () => {

                                        $.ajax({
                                            type: "POST",
                                            url: "/YeniSiparis/UrunGuncelle",
                                            data: std,
                                            dataType:'json',
                                            success: function (result) {

                                                if (result == "basarili") {

                                                    Swal.fire({
                                                        timer: 1500,
                                                        showConfirmButton: false,
                                                        icon: 'success',
                                                        html: true,

                                                        html:


                                                            '<label class=" col-form-label" style="font-size:50px;color:#2c466b">' + data.kodu + '</label><br />' +
                                                            '<label class=" col-form-label" style="font-size:50px;color:#c9222a">' + std.Miktar + ' ' + std.Birim + '</label><br />' +
                                                            '<label class=" col-form-label" style="font-size:30px;color:#2c466b">Olarak Başarılı Bir Şekilde Güncellendi..</label><br /><br />'
                                                        ,

                                                        confirmButtonColor: '#2c466b'

                                                        /*footer: '<a href="">Why do I have this issue?</a>'*/
                                                    })

                                                    //var test = "Müşteri güncellendi.";
                                                    //$("#müsterihubbtn").trigger('müsterieklesilgüncelle', [test]);


                                                }



                                                else {

                                                    Swal.fire({
                                                        icon: 'error',
                                                        title: 'Oops...',
                                                        text: result,
                                                        confirmButtonColor: '#2c466b',
                                                        /*footer: '<a href="">Why do I have this issue?</a>'*/
                                                    })
                                                }

                                            }


                                        })






                                    },
                                    allowOutsideClick: () => !Swal.isLoading()
                                })




                            }
                           
                            else {

                                Swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: result,
                                    confirmButtonColor: '#2c466b',
                                    /*footer: '<a href="">Why do I have this issue?</a>'*/
                                })
                            }

                        }


                    })






                },
                allowOutsideClick: () => !Swal.isLoading()
            })
        }

 
        function SiparisOnayUrunListesi() {
            var std = {

                SiparisTaslakId: $("#siparistaslakId").val(),
                SiparisKodu: $("#sipariskodu").val(),
                SiparisKodSıra: $("#sipariskodsıra").val(),
                MüsteriId: $("#müsteriId").val(),
                EkleyenPersonelId: $("#ekleyenpersonelId").val(),

            }

            $.ajax({
                type: "POST",
                url: "/YeniSiparis/SiparisOnayUrunListesi",
                data: std,
                dataType: 'json',
                success: function (data) {



                    if (data.adet > 0) {
                        siparisOnayla.modalload(data.adet, data.fiyat, data.maliyet);
                        siparisOnayla.eklenenurunlerigetir(data.liste);
                    }



                }


            })

        }
        var siparisOnayla = {

            eklenenurunlerigetir: function (data) {

                var siparisuruntablo = $('#siparisuruntablo').DataTable({

                    /*"dom": 'Blfrtip',*/

                    "responsive": true, "lengthChange": false,
                    "autoWidth": false, "processing": true,
                    "serverSide": false, "select": false,
                    "destroy": true,
                    "lengthMenu": [[5, 10, 30, -1], [5, 10, 30, "All"]],
                    "fixedHeader": true,
                    "scrollX": true,
                    "scrollY": true,


                    "data": data,
                    "columnDefs":
                        [
                            {
                                "targets": [0, 1, 2, 5, 6],
                                "visible": false,
                                "searchable": false,
                            },
                            {
                                "targets": [3, 4, 7, 8, 9, 10, 11, 12],
                                "className": 'dt-center'

                            },





                        ],







                    "columns": [




                        { "data": "id" },
                        { "data": "guncelleyenPersonelId" },
                        { "data": "urunId" },
                        { "data": "kodu" },
                        { "data": "adi" },
                        {
                            "data": "satisFiyat",
                            "render": function (satisFiyat) {
                                return '$' + satisFiyat;

                            }

                        },
                        { "data": "stokAdet" },
                        { "data": "renkKod" },
                        { "data": "kategori" },
                        { "data": "altKategori" },
                        { "data": "miktar" },
                        { "data": "birim" },



                        {
                            "data": null,
                            "className": "düzenle",
                            "render": function (data, type, row) {

                                return '<button class="btn btn-primary btn-icon-anim btn-circle"><i class="fa fa-edit "></i></button> ';
                            },
                            "targets": -1
                        },
                        {
                            "data": null,
                            "className": "sil",
                            "render": function (data, type, row) {

                                return ' <button class="btn btn-danger btn-icon-anim btn-circle"><i class="fa fa-trash "></i></button> ';
                            },
                            "targets": -1
                        }


                    ]


                });
                $('#siparisuruntablo tbody').on('click', '.düzenle', function () {
                    var data = siparisuruntablo.row(this).data();


                    SiparisOnayUrunGuncelle(data);

                });
                $('#siparisuruntablo tbody').on('click', '.sil', function () {
                    var data = siparisuruntablo.row(this).data();


                    SiparisOnayUrunSil(data);

                });
            },
            modalload: function (toplamadet, toplamfiyat, standartmaliyet) {
                var std = {

                    SiparisTaslakId: $("#siparistaslakId").val(),
                    SiparisKodu: $("#sipariskodu").val(),
                    SiparisKodSıra: $("#sipariskodsıra").val(),
                    MüsteriId: $("#müsteriId").val(),
                    EkleyenPersonelId: $("#ekleyenpersonelId").val(),

                }
                Swal.fire({
                    title: '<i  class="fa fa-check-square fa-3x" style="color:#3cb878">' +
                        '<h2 style="color:#2c466b">SİPARİŞ ONAY</h2>',
                    allowOutsideClick: false,
                    html: true,


                    cancelButtonColor: '#c9222a',
                    cancelButtonText: 'Vazgeç',
                    showCancelButton: true,
                    confirmButtonText: 'Onayla',
                    confirmButtonColor: '#2c466b',
                    showLoaderOnConfirm: true,




                    width: '1450px',
                    html:

                        '<div  class="col-sm-12">' +
                        '<label class="col-form-label" style="font-size:25px;color:#2c466b">Taslak Sipariş Kodu :&nbsp&nbsp</label>' +
                        '<label class="col-form-label" style="font-size:25px;color:#c9222a">' + std.SiparisKodu + '</label><br /><br />' +
                        '<label class="col-form-label" style="font-size:20px;color:#2c466b">PO NUMBER &nbsp&nbsp</label>' +

                        '<input id="ponumber" class="col-form-control" style="font-size:20px;color:#c9222a"></input>' +

                        '</div>' +



                        '<div  class="col-sm-12">' +


                        '<table id="siparisuruntablo" class="table table-border-style wrap">' +
                        ' <thead class="wrap">' +
                        '<tr>' +
                        '<th>Id</th>' +
                        '<th>GüncelleyenpersonelId</th>' +
                        '<th>ÜrünId</th>' +
                        '<th style="text-align:center">Ürün Kodu</th>' +
                        '<th style="text-align:center">Ürün Adı</th>' +
                        '<th style="text-align:center">Satış Fiyat</th>' +
                        '<th style="text-align:center">Stok Adet</th>' +
                        '<th style="text-align:center">Renk Kodu</th>' +
                        '<th style="text-align:center">Kategori</th>' +
                        '<th style="text-align:center">Alt <br /> Kategori</th>' +
                        '<th style="align-items:center">Miktar</th>' +
                        '<th style="align-items:center">Birim</th>' +
                        '<th style="align-items:center">Düzenle</th>' +
                        '<th style="align-items:center">Sil</th>' +
                        '</tr>' +
                        '</thead>' +
                        '</table>' +
                        '</div><br /><br />' +
                        '<div  class="input-group row g-3 align-items-center col-sm-12">' +
                        '<div  class="col-sm-6">' +
                        '<label class="col-form-label" style="font-size:25px;color:#2c466b">Açıklama</label><br />' +
                        '<textarea id="aciklama" style="height:150px;width:605px" rows="8" cols="55" class="col-sm-12 form-control"></textarea>' +

                        '</div>' +
                        '<div  class="col-sm-6">' +
                        '<label class="col-form-label" style="font-size:25px;color:#2c466b">Toplam Adet :</label>' +
                        '<label class="col-form-label" style="font-size:45px;color:#c9222a">' + ' ' + '' + toplamadet + ' </label><br />' +
                        '<label class="col-form-label" style="font-size:25px;color:#2c466b">Toplam Fiyat :</label>' +
                        '<label class="col-form-label" style="font-size:45px;color:#c9222a">' + ' ' + '$' + toplamfiyat + ' </label>' +


                        '</div>' +
                        '</div><br />',








                    preConfirm: () => {

                        var st = {
                            Id: $("#siparistaslakId").val(),
                            SiparisKodu: $("#sipariskodu").val(),
                            Miktar: toplamadet,
                            Fiyat: toplamfiyat,
                            MusteriId: $("#musteriId").val(),
                            StandartMaliyet: standartmaliyet,
                            Aciklama: $("#aciklama").val(),
                            PONumber: $("#ponumber").val(),
                        }
                        $.ajax({
                            type: "POST",
                            url: "/YeniSiparis/SiparisOnayla",
                            data: st,
                            dataType: 'json',
                            success: function (durum) {

                                if (durum == "basarili") {

                                    Swal.fire({
                                        timer: 1500,
                                        showConfirmButton: false,
                                        icon: 'success',
                                        html: true,
                                        width: 550,
                                        html:



                                            '<label class=" col-sm-11 col-form-label" style="font-size:40px;color:#2c466b">Başarılı Bir Şekilde Eklendi ve Üretim Planlama Birimine Yönlendirildi. </label><br /><br />'
                                        ,



                                        /*footer: '<a href="">Why do I have this issue?</a>'*/
                                    })

                                    var message = "Siparis Taslak Onaylandı.";
                                    $("#SiparisTaslakHubBtn").trigger('siparistaslakeklesilgüncelle', [message]);
                                    console.log(message);
                                    setTimeout(function () {
                                        $("#renderpage").load("/YeniSiparis");

                                    }, 1800);
                                }
                                else {

                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Oops...',
                                        text: durum,
                                        confirmButtonColor: '#2c466b',
                                        /*footer: '<a href="">Why do I have this issue?</a>'*/
                                    })
                                }

                            }


                        })






                    },
                    allowOutsideClick: () => !Swal.isLoading()
                })
            }
        };
        function SiparisOnayUrunGuncelle(data) {
            Swal.fire({
                title: "<h2 style='color:#c9222a'>Ürün Güncelleme</h2>",
                html: true,

                cancelButtonColor: '#c9222a',
                cancelButtonText: 'Vazgeç',
                showCancelButton: true,
                confirmButtonText: 'Onayla',
                confirmButtonColor: '#2c466b',
                showLoaderOnConfirm: true,
                allowOutsideClick: false,

                width: '600px',
                html:

                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                    '<label  class="  col-form-label" style="font-size:20px;float:left">Ürün Kodu</label><br />' +
                    ' <input type="text" style="height:38px;font-size:30px" value="' + data.kodu + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi"  disabled ><br />' +
                    '</div>' +
                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                    '<label  class=" col-form-label" style="font-size:20px;float:left">Renk Kodu</label><br />' +
                    ' <input type="text" style="height:38px;font-size:30px" value="' + data.renkKod + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi" disabled ><br />' +
                    '</div>' +
                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                    '<label  class="  col-form-label" style="font-size:20px;float:left">Kategori</label><br />' +
                    ' <input type="text" style="height:38px;font-size:30px" value="' + data.kategori + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi"  disabled><br />' +
                    '</div>' +
                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                    '<label  class=" col-form-label" style="font-size:20px;float:left">Fiyat</label><br />' +
                    ' <input type="text" style="height:38px;font-size:30px" value="' + '$' + data.satisFiyat + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi"  disabled ><br /><br />' +
                    '</div><br />' +

                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                    '<div class="col-md-1">' +
                    '</div>' +
                    ' <input type="number" style="width:205px;height:45px;font-size:40px;color:#c9222a" value="' + data.miktar + '" id="copymiktar" class="col-sm-5 form-control form-control-center"  >' +
                    '<div class="col-md-1">' +
                    '</div>' +
                    '<select id="copybirim" style="width:205px;height:45px"  class="form-control col-md-5">' +
                    '<option value ="Adet" >Adet</option >' +
                    '<option value="Kilogram">Kilogram</option>' +
                    '<option value="Metre">Metre</option>' +
                    '<option value="Ton">Ton</option>' +
                    '</select >' +

                    '</div>' +








                    '</div>',




                preConfirm: () => {

                    var std = {
                        
                        SiparisTaslakId: $("#siparistaslakId").val(),
                        UrunId: data.urunId,
                        UrunKodu: data.kodu,
                        UrunAdi: data.adi,
                        Miktar: $("#copymiktar").val(),
                        Birim: $("#copybirim").val(),
                        SiparisKodu: $("#sipariskodu").val(),
                        SiparisKodSıra: $("#sipariskodsıra").val(),
                        MusteriId: $("#müsteriId").val(),
                        EkleyenPersonelId: $("#ekleyenpersonelId").val(),

                    }
                    $.ajax({
                        type: "POST",
                        url: "/YeniSiparis/UrunGuncelle",
                        data: std,
                        dataType: 'json',
                        success: function (data) {

                            if (data == "basarili") {



                                $("#siparisonayla").trigger('click');
                               


                            }



                            else {

                                Swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: data,
                                    confirmButtonColor: '#2c466b',
                                    /*footer: '<a href="">Why do I have this issue?</a>'*/
                                })
                            }

                        }


                    })






                },
                allowOutsideClick: () => !Swal.isLoading()
            })
        }
        function SiparisOnayUrunSil(data) {
            
            var std = {
                Id: data.id,
                SiparisTaslakId: $("#siparistaslakId").val(),
                UrunId: data.urunId,
                UrunKodu: data.kodu,
                UrunAdi: data.adi,
                Miktar: $("#copymiktar").val(),
                Birim: $("#copybirim").val(),
                SiparisKodu: $("#sipariskodu").val(),
                SiparisKodSıra: $("#sipariskodsıra").val(),
                MusteriId: $("#müsteriId").val(),
                EkleyenPersonelId: $("#ekleyenpersonelId").val(),

            }
            const swalWithBootstrapButtons = Swal.mixin({
                customClass: {
                    confirmButton: 'btn btn-success btn-round',
                    cancelButton: 'btn btn-danger btn-round',
                },
                focusConfirm: false,
                buttonsStyling: false

            })

            swalWithBootstrapButtons.fire({
                title: 'Emin Misiniz ?',
                text: 'Seçtiğiniz' + ' ' + data.kodu + ' Kodlu Ürün Silinmek Üzere..',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'EVET',
                cancelButtonText: 'HAYIR',


            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: "POST",
                        url: "/YeniSiparis/SiparisOnayUrunSil",
                        data: std,
                        dataType: 'json',
                        success: function (data) {

                            if (data.durum == "basarili") {


                                $("#siparisonayla").trigger('click');


                            }
                            else {

                                Swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: durum,
                                    confirmButtonColor: '#2c466b',
                                    /*footer: '<a href="">Why do I have this issue?</a>'*/
                                })
                            }

                        }


                    })





                }


            })
        }



















        var uruntablo;
        $(document).ready(function () {
            uruntablo = $('#uruntablo').DataTable({

                "dom": 'Blfrtip',

                "responsive": true, "lengthChange": false,
                "autoWidth": false, "processing": true,
                "serverSide": false, "select": false,
                "destroy": true,
                "lengthMenu": [[5, 10, 30, -1], [5, 10, 30, "All"]],
                "fixedHeader": true,
                "scrollX": true,
                "scrollY": true,

                "ajax": {
                    "url": "/YeniSiparis/UrunListesi",
                    "type": "GET"
                },
                "columnDefs":
                    [
                        {
                            "targets": [0, 1],
                            "visible": false,
                            "searchable": false,
                        },
                        {
                            "targets": [2, 3, 4, 5, 6, 7, 8, 9, 10],
                            "className": 'dt-body-center'

                        },



                    ],

                "buttons": [
                    {
                        extend: 'copyHtml5',
                        exportOptions: {
                            columns: [2, 3, 4, 5, 6, 7]
                        }
                    },
                    {
                        extend: 'excelHtml5',
                        exportOptions: {
                            columns: [2, 3, 4, 5, 6, 7]
                        }
                    },
                    {
                        extend: 'pdfHtml5',
                        exportOptions: {
                            columns: [2, 3, 4, 5, 6, 7]
                        }
                    },
                    /*'colvis'*/
                ],





                "columns": [




                    { "data": "id" },
                    { "data": "guncelleyenPersonelId" },
                    { "data": "kodu" },
                    { "data": "adi" },
                    {
                        "data": "satisFiyat",
                        "render": function (satisFiyat) {
                            return '$' + satisFiyat;

                        }

                    },
                    { "data": "stokAdet" },
                    { "data": "renkKod" },
                    { "data": "kategori" },
                    { "data": "altKategori" },



                    {
                        "data": null,
                        "className": "miktar",
                        "render": function (data, type, row) {

                            return '<input id="miktar' + data.id + '" value="" style="width:85px;height:30px;align-items:center" type="number"  class="form-control" placeholder="Miktar" min="0"> ';
                        },
                        "targets": -1
                    },
                    {
                        "data": null,

                        "className": "birim",
                        "render": function (data, type, row) {

                            return '<select id="birim' + data.id + '" style="width:auto;height:30px" name="birim" class="form-control">' +
                                '<option value ="Adet" >Adet</option >' +
                                '<option value="Kilogram">Kilogram</option>' +
                                '<option value="Metre">Metre</option>' +
                                '<option value="Ton">Ton</option>' +

                                '</select >';

                        },
                        "targets": -1
                    },
                    {
                        "data": null,
                        "className": "urunekle",
                        "render": function (data, type, row) {

                            return ' <button class="btn btn-success btn-icon-anim btn-circle"><i class="fa fa-plus "></i></button> ';
                        },
                        "targets": -1
                    }


                ]


            });



            $('#uruntablo tbody').on('click', '.urunekle', function () {
                var data = uruntablo.row(this).data();
                var miktar = $('#miktar' + data.id + '').val();
                var birim = $('#birim' + data.id + '').val();
                var valid = false;
                if ((miktar == 0 || undefined)) {

                    
                    Swal.mixin({
                        toast: true,
                        position: 'top',
                        iconColor: 'white',
                        customClass: {
                            popup: 'colored-toast'
                        },
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,

                    }).fire({
                        icon: 'error',
                        title: 'Miktar " 0 "  veya " BOŞ " Olamaz..',
                        width: '500px'

                    })


                }

                else {
                    valid = true;

                }

                urunekle(data, miktar, birim, valid);




            });



        });


        function urunekle(data, miktar, birim, valid) {



            if (valid) {
                var std = {
                    
                    Id: $("#siparistaslakdetayid").val(),
                    SiparisTaslakId: $("#siparistaslakId").val(),
                    UrunId: data.id,
                    UrunKodu: data.kodu,
                    UrunAdi: data.adi,
                    Miktar: miktar,
                    Birim: birim,
                    SiparisKodu: $("#sipariskodu").val(),
                    SiparisKodSıra: $("#sipariskodsıra").val(),
                    EkleyenPersonelId: $("#ekleyenpersonelId").val(),

                }

                var toplamfiyat = data.satisFiyat * miktar;

                $.ajax({
                    type: "POST",
                    url: "/YeniSiparis/UrunEkle",
                    data: std,
                    dataType: 'json',
                    success: function (durum) {

                        if (durum=="basarili") {

                            Swal.fire({
                                timer: 1500,
                                showConfirmButton: false,
                                icon: 'success',
                                html: true,

                                html:


                                    '<label class=" col-form-label" style="font-size:50px;color:#2c466b">' + data.kodu + '</label><br />' +
                                    '<label class=" col-form-label" style="font-size:50px;color:#c9222a">' + miktar + ' ' + birim + '</label><br />' +
                                    '<label class=" col-form-label" style="font-size:30px;color:#2c466b">Başarılı Bir Şekilde Taslak Siparişe Eklendi..</label><br /><br />'
                                ,

                                confirmButtonColor: '#2c466b'

                                /*footer: '<a href="">Why do I have this issue?</a>'*/
                            })




                        }

                        else if (durum == "urunguncelle") {
                            Swal.fire({
                                title: "<h2 style='color:#c9222a'>ÜRÜN SİPARİŞTE MEVCUT!</h2>",
                                html: true,

                                cancelButtonColor: '#c9222a',
                                cancelButtonText: 'Vazgeç',
                                showCancelButton: true,
                                confirmButtonText: 'Onayla',
                                confirmButtonColor: '#2c466b',
                                showLoaderOnConfirm: true,
                                allowOutsideClick: false,
                                width: '600px',
                                html:



                                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                                    '<label  class="  col-form-label" style="font-size:20px;float:left">Ürün Kodu</label><br />' +
                                    ' <input type="text" style="height:38px;font-size:30px" value="' + data.kodu + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi"  disabled ><br />' +
                                    '</div>' +
                                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                                    '<label  class=" col-form-label" style="font-size:20px;float:left">Renk Kodu</label><br />' +
                                    ' <input type="text" style="height:38px;font-size:30px" value="' + data.renkKod + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi" disabled ><br />' +
                                    '</div>' +
                                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                                    '<label  class="  col-form-label" style="font-size:20px;float:left">Kategori</label><br />' +
                                    ' <input type="text" style="height:38px;font-size:30px" value="' + data.kategori + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi"  disabled><br />' +
                                    '</div>' +
                                    '<div  class="form-group row g-3 align-items-center col-sm-12">' +
                                    '<label  class=" col-form-label" style="font-size:20px;float:left">Fiyat</label><br />' +
                                    ' <input type="text" style="height:38px;font-size:30px" value="' + '$' + data.satisFiyat + '" id="Adi" class="col-sm-8 form-control form-control-center" name="Adi"  disabled ><br />' +
                                    '</div><br />' +
                                    '<label class="  col-form-label" style="font-size:50px;color:#2c466b">' + miktar + ' ' + birim + '</label><br /><br />' +
                                    '<label class="  col-form-label" style="font-size:30px;color:#2c466b">Olarak Güncellenecek Onalıyor Musunuz??</label><br /><br /><br />' +
                                    '<label class="  col-form-label" style="font-size:30px;color:#c9222a">TOPLAM :$' + toplamfiyat + '</label>' +
                                    '</div>',





                                preConfirm: () => {

                                    $.ajax({
                                        type: "POST",
                                        url: "/YeniSiparis/UrunGuncelle",
                                        data: std,
                                        dataType: 'json',
                                        success: function (durum) {

                                            if (durum == "basarili") {

                                                Swal.fire({
                                                    timer: 2000,
                                                    showConfirmButton: false,
                                                    icon: 'success',
                                                    html: true,

                                                    html:


                                                        '<label class=" col-form-label" style="font-size:50px;color:#2c466b">' + data.kodu + '</label><br />' +
                                                        '<label class=" col-form-label" style="font-size:50px;color:#c9222a">' + miktar + ' ' + birim + '</label><br />' +
                                                        '<label class=" col-form-label" style="font-size:30px;color:#2c466b">Olarak Başarılı Bir Şekilde Güncellendi..</label><br /><br />'
                                                    ,

                                                    confirmButtonColor: '#2c466b'

                                                    /*footer: '<a href="">Why do I have this issue?</a>'*/
                                                })

                                                //var test = "Müşteri güncellendi.";
                                                //$("#müsterihubbtn").trigger('müsterieklesilgüncelle', [test]);


                                            }



                                            else {

                                                Swal.fire({
                                                    icon: 'error',
                                                    title: 'Oops...',
                                                    text: durum,
                                                    confirmButtonColor: '#2c466b',
                                                    /*footer: '<a href="">Why do I have this issue?</a>'*/
                                                })
                                            }

                                        }


                                    })






                                },
                                allowOutsideClick: () => !Swal.isLoading()
                            })




                        }
                        
                        else {

                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: durum,
                                confirmButtonColor: '#2c466b',
                                /*footer: '<a href="">Why do I have this issue?</a>'*/
                            })
                        }

                    }


                })

            }



        }


        $(window).bind('beforeunload', function () {
            pageclosing();

        });




        function pageclosing() {
            var std = {

                SiparisTaslakId: $("#siparistaslakId").val(),
                SiparisKodu: $("#kod").val(),
                SiparisKodSıra: $("#kodsıra").val(),
                MüsteriId: $("#müsteriId").val(),
                EkleyenPersonelId: $("#ekleyenpersonelId").val(),

            }
            $.ajax({
                type: "POST",
                url: "/YeniSiparis/PageClosing",
                data: std,
                dataType: 'json',



            })

        }

    </script>

    <script>

        $(document).ready(function () {

            const conn = new signalR.HubConnectionBuilder().withUrl("/SiparisTaslakHub").build();
            conn.start();

            $("#SiparisTaslakHubBtn").on('siparistaslakeklesilgüncelle', function (event, message) {



                conn.invoke("SiparisTaslakTabloReload", message);



            });
            conn.on("siparistaslakeklesilgüncelle", message => {
                taslaksiparisler.ajax.reload();

            })








        });







    </script>





</body>
</html>